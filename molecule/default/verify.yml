---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Ensure Unbound is running
      service:
        name: unbound
        state: started
      register: result
      check_mode: true
      failed_when: result is changed

    - name: Ensure Unbound configuration is correct
      copy:
        content: |
          # Ansible managed: Do NOT edit this file manually!

          server:
              harden-large-queries: yes
              harden-short-bufsize: yes
              incoming-num-tcp: "1"
              infra-cache-numhosts: "200"
              infra-cache-slabs: "1"
              interface: 127.0.0.1
              key-cache-size: "100k"
              key-cache-slabs: "1"
              msg-buffer-size: "8192"
              msg-cache-size: "100k"
              msg-cache-slabs: "1"
              neg-cache-size: "10k"
              num-queries-per-thread: "30"
              num-threads: "1"
              outgoing-num-tcp: "1"
              outgoing-range: "60"
              rrset-cache-size: "100k"
              rrset-cache-slabs: "1"
              target-fetch-policy: "2 1 0 0 0 0"

          stub-zone:
              name: consul
              stub-addr: "127.0.0.1@8600"

          forward-zone:
              name: "."
              forward-addr: 1.1.1.1
              forward-addr: 9.9.9.9

          forward-zone:
              name: "metabrainz.org"
              forward-addr: 127.0.1.42
              forward-addr: 127.0.42.1
        dest: /etc/unbound/unbound.conf
        mode: "0644"
      register: result
      check_mode: true
      failed_when: result is changed

    - name: Ensure google.com resolves
      # noqa risky-shell-pipe
      shell: "dig A google.co.uk @127.0.0.1 | grep -q 'status: NOERROR'"
      changed_when: false

    - name: Ensure query to invalid stub-zone fails
      # noqa risky-shell-pipe
      shell: "dig A example.consul @127.0.0.1 | grep -q 'status: SERVFAIL'"
      changed_when: false

    - name: Ensure query to invalid forward-zone fails
      # noqa risky-shell-pipe
      shell: "dig A metabrainz.org @127.0.0.1 | grep -q 'status: SERVFAIL'"
      changed_when: false
